---

title: Sensors


keywords: fastai
sidebar: home_sidebar

summary: "reads sensor data over UART"
description: "reads sensor data over UART"
nb_path: "07_sensors.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 07_sensors.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/Users/eway/.pyenv/versions/3.8.3/lib/python3.8/site-packages/pandas/compat/__init__.py:97: UserWarning: Could not import the lzma module. Your installed Python is incomplete. Attempting to use lzma compression will result in a RuntimeError.
  warnings.warn(msg)
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Sensor data packet read and decode pyserial code below. Modified from a past project of mine.</p>
<p>Todo: Read the RTC timestamp at beginning of collection. The data packets only contain timestamp offsets.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">read_packet</span><span class="p">(</span><span class="n">header</span><span class="p">:</span><span class="nb">chr</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">num_bytes</span><span class="p">:</span><span class="nb">int</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span><span class="nb">float</span> <span class="o">=</span> <span class="mf">6.</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;byte string&quot;</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Reads `num_bytes` of a data packet starting with `header` and timing out after `timeout` seconds if packet is invalid.&quot;&quot;&quot;</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&quot;&quot;</span>
    
    <span class="c1"># Check for packet start of frame</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">in_waiting</span><span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">b</span> <span class="o">==</span>  <span class="sa">b</span><span class="s1">&#39;*&#39;</span><span class="p">:</span>
                <span class="c1">#print(&quot;Received Packet&quot;)</span>
                <span class="k">break</span>
            
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No data packets.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
    
    <span class="c1"># read the rest of data packet</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_bytes</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Received Incomplete Packet&quot;</span><span class="p">)</span>
            <span class="k">break</span>
        
        <span class="k">if</span> <span class="n">ser</span><span class="o">.</span><span class="n">in_waiting</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">buff</span> <span class="o">+=</span> <span class="n">ser</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            
    <span class="k">return</span> <span class="n">buff</span>

<span class="k">def</span> <span class="nf">decode_packet</span><span class="p">(</span><span class="n">buff</span><span class="p">:</span><span class="s2">&quot;byte string&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Decode `buff` into a list of decoded variables&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">buff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    
    <span class="n">contents</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">np_buff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">buff</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    
    <span class="c1"># Real Time Clock</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>    <span class="p">)</span> <span class="c1"># rtc timestamp offset [ms]</span>
    
    <span class="c1"># Humidity, Pressure sensor</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>    <span class="p">)</span> <span class="c1"># humidity timestamp offset [ms]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">12</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># temperature [deg C]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># pressure [hPa]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># humidity [relative humidity %]</span>
    
    <span class="c1"># Inertial Measurement Unit</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">20</span><span class="p">:</span><span class="mi">24</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># imu timestamp offset [ms]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">28</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># quaternion w</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># quaternion x</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">32</span><span class="p">:</span><span class="mi">36</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># quaternion y</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">40</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># quaternion z</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">40</span><span class="p">:</span><span class="mi">41</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>   <span class="p">)</span> <span class="c1"># calibration status</span>
    
    <span class="c1"># Global Positioning System</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">41</span><span class="p">:</span><span class="mi">45</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># gps timestamp offset [ms]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">45</span><span class="p">:</span><span class="mi">49</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>   <span class="p">)</span> <span class="c1"># latitude [deg *10^-7]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">53</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>   <span class="p">)</span> <span class="c1"># longitude [deg *10^-7]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">53</span><span class="p">:</span><span class="mi">57</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>   <span class="p">)</span> <span class="c1"># altitude [mm above ellipsoid]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">57</span><span class="p">:</span><span class="mi">58</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>   <span class="p">)</span> <span class="c1"># number of satellites in view and used in compute</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">58</span><span class="p">:</span><span class="mi">62</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>   <span class="p">)</span> <span class="c1"># ground speed [mm/s]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">62</span><span class="p">:</span><span class="mi">66</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>   <span class="p">)</span> <span class="c1"># heading of motion [deg *10^-5]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">66</span><span class="p">:</span><span class="mi">68</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint16</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># position DOP [*0.01]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">68</span><span class="p">:</span><span class="mi">72</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># horizontal accuracy estimate [mm]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">72</span><span class="p">:</span><span class="mi">76</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># vertical accuracy estimate [mm]</span>
    <span class="n">contents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">np_buff</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">80</span><span class="p">]</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint32</span><span class="p">)</span>  <span class="p">)</span> <span class="c1"># heading accuracy estimate (both motion and vehicle) [deg *10^-5]</span>
    
    <span class="k">return</span> <span class="n">contents</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SensorStream" class="doc_header"><code>class</code> <code>SensorStream</code><a href="https://github.com/openhsi/openhsi/tree/master/openhsi/sensors.py#L57" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SensorStream</code>(<strong><code>baudrate</code></strong>=<em><code>921600</code></em>, <strong><code>port</code></strong>=<em><code>'/dev/ttyTHS0'</code></em>, <strong><code>start_pin</code></strong>=<em><code>27</code></em>, <strong><code>save_dir</code></strong>=<em><code>'/xavier_ssd/data/'</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">SensorStream</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">921_600</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="s2">&quot;/dev/ttyTHS0&quot;</span><span class="p">)</span>
<span class="n">peripherals</span><span class="o">.</span><span class="n">run</span><span class="p">()</span> <span class="c1"># start on switch on, pause on switch off, KeyboardInterrupt to stop</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">peripherals</span> <span class="o">=</span> <span class="n">SensorStream</span><span class="p">(</span><span class="n">baudrate</span><span class="o">=</span><span class="mi">921_600</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="s2">&quot;/dev/ttyTHS0&quot;</span><span class="p">)</span>
<span class="n">peripherals</span><span class="o">.</span><span class="n">record</span><span class="p">(</span><span class="n">max_timeout</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">peripherals</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>test
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ValueError</span>                                Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-306-56153777548f&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-red-fg">#test</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;test&#34;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg">----&gt; 3</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">raise</span> ValueError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">&#34;Test flag entered&#34;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">ValueError</span>: Test flag entered</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hardware&quot;</span><span class="p">)</span>
<span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Hardware flag entered&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>hardware
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;skip&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>skip
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

